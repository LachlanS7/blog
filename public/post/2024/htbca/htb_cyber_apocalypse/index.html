<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://lachlans7.com/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://lachlans7.com/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://lachlans7.com/css/github.min.css' />
    <link rel="stylesheet" href='https://lachlans7.com/css/github-style.css' />
    <link rel="stylesheet" href='https://lachlans7.com/css/light.css' />
    <link rel="stylesheet" href='https://lachlans7.com/css/dark.css' />
    <link rel="stylesheet" href='https://lachlans7.com/css/syntax.css' />
    <title>Cyber Apocalypse 2024 - ROT128 - LachlanS7&#39;s Blog</title>
    
    <link rel="icon" type="image/x-icon" href='/images/github.png'>
    
    <meta name="theme-color" content="#1e2327">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
    onload="renderMathInElement(
          document.body,
          {
              delimiters: [
                  {left: '$$', right: '$$', display: true},
                  {left: '\\[', right: '\\]', display: true},
                  {left: '$', right: '$', display: false},
                  {left: '\\(', right: '\\)', display: false}
              ]
          }
      );"></script>


</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://lachlans7.com/">
        <img class="octicon" height="32" width="32" src="/images/GitHub-Mark-Light-32px.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <img height="24" class="octicon octicon-three-bars" width="24" src="/images/GitHub-Mark-Light-32px.png">
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://lachlans7.com/">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://lachlans7.com/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/GitHub-Mark-Light-32px.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://lachlans7.com/">
                  <img class=" avatar-user"
                    src="/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://lachlans7.com/">LachlanS7</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://lachlans7.com/post/2024/htbca/htb_cyber_apocalypse/">Cyber Apocalypse 2024 - ROT128</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Sun, 17 Mar 2024 17:22:12 &#43;1030"
                    class="no-wrap">
                    Sun, 17 Mar 2024 17:22:12 &#43;1030</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Sun, 17 Mar 2024 22:45:16 &#43;1030"
                    class="no-wrap">
                    Sun, 17 Mar 2024 22:45:16 &#43;1030</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      1597 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><h1 id="cyber-apocalypse-2024---rot128">Cyber Apocalypse 2024 - ROT128</h1>
<blockquote>
<p>In the eerie stillness of the Bitting village, a dilapidated laboratory lies forgotten and forsaken, its ancient walls whispering secrets of unspeakable horrors. As you awaken within its confines, a shiver runs down your spine, the air thick with the weight of untold darkness. With no recollection of how you came to be here, you begin to explore the place. The dim glow of flickering lights casts long shadows across the worn floors, revealing rusted equipment and decaying machinery. The air is heavy with the scent of decay and abandonment, a tangible reminder of the atrocities that once transpired within these walls. Soon, you uncover the sinister truth lurking within the laboratory&rsquo;s forgotten depths. This place was a chamber of horrors, a breeding ground for abominable experiments in human cloning. The realization sends chills coursing through your veins, your mind reeling at the thought of the atrocities committed in the name of science. But there is no time to dwell on the horrors of the past, because a sinister countdown echoes through the laboratory, its ominous tones a harbinger of impending doom. Racing against the ticking clock, you discover the source of the impending catastrophe—a chemical reactor primed to unleash devastation upon the village. With the weight of the world upon your shoulders, you realize that you alone possess the knowledge to defuse the deadly device. As a chemist, you understand the delicate balance of chemical reactions, and you know that triggering a specific collision multiple times is the key to averting disaster. With steady hands and a racing heart, you get to work. As the seconds tick away, you feel the weight of the world bearing down upon you, but you refuse to falter.</p>
</blockquote>
<p>In this challenge, we are provided the source code to the server running. In summary, the server is generating a random 32 byte message (<code>buffer</code>) and is hashing it with the random state $(r_1, r_2, r_3, r_4, K_1, K_2)$ using the following code;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">N</span> <span class="o">=</span> <span class="mi">128</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HashRoll</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">reset_state</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">hash_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_ROL_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">r1</span><span class="p">)</span> <span class="o">^</span> <span class="n">_ROL_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">r2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="n">N</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reset_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">digest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buffer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;big&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">m1</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">&gt;&gt;</span> <span class="n">N</span>
</span></span><span class="line"><span class="cl">        <span class="n">m2</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">+=</span> <span class="nb">int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_step</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">m1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="k">else</span> <span class="n">m2</span><span class="p">),</span> <span class="n">length</span><span class="o">=</span><span class="n">N</span><span class="o">//</span><span class="mi">8</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;big&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">h</span>
</span></span></code></pre></div><p>Our goal is to input states $(r_1,r_2,r_3,r_4,K_1, K_2) \in \mathbb{Z}_N^4 \times \mathbb{Z}_{2^N-1}^2$ such that we get a hash collision (same hash and plaintexts, different states). There are a total of 3 rounds, and each time, the server gives us the plaintext and the result of the hash:</p>
<blockquote>
<p>H(8a9d3871eaa65c69c88bac3aa6b821cc730383dbf0b6e124e439c82d2927b74d) = 981aa55dfa699f4970c94d08dca82cfddde61e903eba6a3d8e12f91332f15583</p>
</blockquote>
<p>To solve this challenge, I first noticed that we can easily recover the results of the <code>hash_step</code> function just by splitting the resultant hash into 16 byte blocks and xoring them with the corresponding 16 byte blocks of the plain text. The following code achieves this;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Break the plaintext (pt) into 16 byte blocks</span>
</span></span><span class="line"><span class="cl"><span class="n">pt0</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">&gt;&gt;</span> <span class="n">N</span>
</span></span><span class="line"><span class="cl"><span class="n">pt1</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Break the hash into 16 byte blocks</span>
</span></span><span class="line"><span class="cl"><span class="n">ht0</span> <span class="o">=</span> <span class="nb">hash</span> <span class="o">&gt;&gt;</span> <span class="n">N</span>
</span></span><span class="line"><span class="cl"><span class="n">ht1</span> <span class="o">=</span> <span class="nb">hash</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Recover the hash_step results</span>
</span></span><span class="line"><span class="cl"><span class="n">H0</span> <span class="o">=</span> <span class="n">pt0</span> <span class="o">^^</span> <span class="n">ht0</span>
</span></span><span class="line"><span class="cl"><span class="n">H1</span> <span class="o">=</span> <span class="n">pt1</span> <span class="o">^^</span> <span class="n">ht1</span>
</span></span></code></pre></div><p>As we cannot control the plaintext, our only way to get a hash collision is to pick a state that produces the same output from the <code>hash_step</code> function with the server&rsquo;s random state. So let us look at the <code>hash_step</code> function more closely:</p>
<h2 id="the-hash-step-function">The Hash Step Function</h2>
<p>The <code>hash_step</code> function has code</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hash_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_ROL_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">r1</span><span class="p">)</span> <span class="o">^</span> <span class="n">_ROL_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">r2</span><span class="p">)</span>
</span></span></code></pre></div><p>where the <code>_ROL_</code> function is a 128-bit binary rotate left / circular bit shift. In summary, the code is giving us;
$$
H_0 = (K_1 \lll r_1)\oplus(K_2 \lll r_2)\\
H_1 = (K_1 \lll r_3)\oplus(K_2 \lll r_4),
$$
where $H_0$ and $H_1$ are the results of <code>hash_step(0)</code> and <code>hash_step(1)</code> respectively. It is this intertwining of $K_1$ and $K_2$ which makes this challenge difficult. If it were that $H_0$ was only a function of $K_1$ and $H_1$ only a function of $K_2$, it would be much simplier. Nonetheless, we know $H_0$ and $H_1$, and thus we need to pick an appropriate $r_1, &hellip;, r_4, K_1, K_2$ which will give us our desired values of $H_1$ and $H_2$. To do this, let us assert that $r_1, r_3 = 0$ (we can do this as rotations are relative). With some simple rearrangements, we get the equations
$$
K_1 = H_0 \oplus (K_2 \lll r_2)\\
K_1 = H_1\oplus(K_2 \lll r_4). \tag{1}
$$
which gives
$$
H_0 \oplus (K_2 \lll r_2) = H_1\oplus(K_2 \lll r_4)\\
\implies H_0 \oplus H_1 = (K_2 \lll r_2) \oplus (K_2 \lll r_4).
$$
Finally, if we assert $r_2 = 0$, we get
$$H_0 \oplus H_1 = K_2 \oplus (K_2 \lll r_4).$$
This equation is much simpler to solve. To solve it, we will consider $K_2$ and $H_0$ as vectors in $\mathbb{Z}_2^N$. We chose this field as XOR of two numbers becomes addition over their corresponding vectors. In otherwords,</p>
<p>$$(\mathbb{Z}_{2^N-1}, \oplus) \cong (\mathbb{Z}_2^N, +)$$</p>
<p>through the map $f : \mathbb{Z}_{2^N-1} \to \mathbb{Z}_2^N$ defined by</p>
<p>$$[f(x)]_j = \left[f\left(\sum_{i=0}^N c_i 2^i\right)\right]_j = c_j,$$</p>
<p>where $c_i \in \mathbb{Z}_2$.</p>
<p>Additionally, we can describe a left binary rotation by one bit through transformation corresponding to the block matrix
$$R = \begin{bmatrix}
0 &amp; 1\\
\mathbb{I}_{N-1} &amp; 0
\end{bmatrix},$$
where $\mathbb{I}_{N-1}$ is the identity matrix of size $N$. With this, we can rewrite the defining equation of $K_2$ as
$$
(R^{r_4} + \mathbb{I}_N) f(K_2) = f(H_0 \oplus H_1) = f(H_0) + f(H_1). \tag{2}
$$
This equation can be efficently solved! To do this, we will use <a href="https://www.sagemath.org/">SageMath</a>. The following code sets up the equation and solve it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sage" data-lang="sage"><span class="line"><span class="cl"><span class="c1"># Defining N</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">=</span> <span class="mi">12</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Defining the Galois field (Z_2)</span>
</span></span><span class="line"><span class="cl"><span class="n">F</span> <span class="o">=</span> <span class="n">GF</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Defining isomorpism maps</span>
</span></span><span class="line"><span class="cl"><span class="n">isoMap</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">vector</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl"><span class="n">invIsoMap</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="nb">sum</span><span class="p">([</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Creating rotation matrix and identity matrix</span>
</span></span><span class="line"><span class="cl"><span class="n">R</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">I</span> <span class="o">=</span> <span class="n">identity_matrix</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Creating the matrix on the LHS of the defining equation</span>
</span></span><span class="line"><span class="cl"><span class="n">M</span> <span class="o">=</span> <span class="n">R</span><span class="o">**</span><span class="n">r4</span> <span class="o">+</span> <span class="n">I</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Solving for K_2</span>
</span></span><span class="line"><span class="cl"><span class="n">K2</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">solve_right</span><span class="p">(</span><span class="n">isoMap</span><span class="p">(</span><span class="n">H0</span><span class="p">)</span> <span class="o">+</span> <span class="n">isoMap</span><span class="p">(</span><span class="n">H1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">K2</span> <span class="o">=</span> <span class="n">invIsoMap</span><span class="p">(</span><span class="n">K2</span><span class="p">)</span>
</span></span></code></pre></div><p>This does however beg one question: what is $r_4$? While there might be some ways to calculate valid values of $r_4$, it is just easier to bruteforce a value of $r_4$ as we have to check at most $N$ (128) values of $r_4$ before we find a valid one. In fact, this value is even lower, as if the random state used on the server had an $r_4$ value of $r_4&rsquo;$, then there will be
$$\frac{N}{gcd(N, r_4&rsquo;)}$$
valid values of $r_4$. Thus as solving <em>equation (2)</em> is very efficient, we can do this within a very short time &ndash; short enough before the server disconnects us. From here, we can simply calculate $K_1$ via <em>equation (1)</em>.</p>
<h2 id="the-final-solution">The Final Solution</h2>
<p>Put all together, we have the following steps to our solution:</p>
<ol>
<li>Split the hash and plaintext into 2 blocks of 16 bytes each</li>
<li>Calculate $H_1$ and $H_2$ by xoring the corresponding plaintext and hash blocks</li>
<li>Xor $H_1$ and $H_2$ and solve for $K_2$ using <em>equation (2)</em></li>
<li>Calculate $K_1$ from $K_2$ using <em>equation (1)</em></li>
<li>Send back the new key $(0, 0, 0, r_4, K_1, K_2)$</li>
<li>Repeat for all 3 rounds!</li>
</ol>
<p>Putting this all together using <code>pwntools</code> and SageMath gives us the following script</p>
<blockquote>
<details>
  <summary><code>solution.sage</code></summary>
  <p></p>
  <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sage" data-lang="sage"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Defining N</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">=</span> <span class="mi">128</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Defining the Galois field (Z_2)</span>
</span></span><span class="line"><span class="cl"><span class="n">F</span> <span class="o">=</span> <span class="n">GF</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Defining isomorpism maps</span>
</span></span><span class="line"><span class="cl"><span class="n">isoMap</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">vector</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="o">**</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl"><span class="n">invIsoMap</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Creating rotation matrix and identity matrix</span>
</span></span><span class="line"><span class="cl"><span class="n">R</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">GF</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">N</span> <span class="o">==</span> <span class="n">j</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">I</span> <span class="o">=</span> <span class="n">identity_matrix</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Connecting to server</span>
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="s2">&#34;94.237.49.166&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">port</span> <span class="o">=</span> <span class="mi">40937</span>
</span></span><span class="line"><span class="cl"><span class="n">local</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">local</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">shell</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">&#34;python&#34;</span><span class="p">,</span> <span class="s2">&#34;server.py&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">shell</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Clearing out server intro</span>
</span></span><span class="line"><span class="cl"><span class="n">shell</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Making an array for used states cannot be reused</span>
</span></span><span class="line"><span class="cl"><span class="n">usedStates</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Getting plaintext and hash</span>
</span></span><span class="line"><span class="cl">    <span class="n">info</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">recvlines</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">hash</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Break the plaintext (pt) into 16 byte blocks</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt0</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">&gt;&gt;</span> <span class="n">N</span>
</span></span><span class="line"><span class="cl">    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Break the hash into 16 byte blocks</span>
</span></span><span class="line"><span class="cl">    <span class="n">ht0</span> <span class="o">=</span> <span class="nb">hash</span> <span class="o">&gt;&gt;</span> <span class="n">N</span>
</span></span><span class="line"><span class="cl">    <span class="n">ht1</span> <span class="o">=</span> <span class="nb">hash</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Recover the hash_step results</span>
</span></span><span class="line"><span class="cl">    <span class="n">H0</span> <span class="o">=</span> <span class="n">pt0</span> <span class="o">^^</span> <span class="n">ht0</span>
</span></span><span class="line"><span class="cl">    <span class="n">H1</span> <span class="o">=</span> <span class="n">pt1</span> <span class="o">^^</span> <span class="n">ht1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># For loop over possible r4</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">r4</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">N</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">r4</span> <span class="ow">in</span> <span class="n">usedStates</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Creating the matrix on the LHS of the defining equation</span>
</span></span><span class="line"><span class="cl">        <span class="n">M</span> <span class="o">=</span> <span class="n">R</span><span class="o">**</span><span class="n">r4</span> <span class="o">+</span> <span class="n">I</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Solving for K_2</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">K2</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">solve_right</span><span class="p">(</span><span class="n">isoMap</span><span class="p">(</span><span class="n">H0</span><span class="p">)</span> <span class="o">+</span> <span class="n">isoMap</span><span class="p">(</span><span class="n">H1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Calculating K_1</span>
</span></span><span class="line"><span class="cl">        <span class="n">K1</span> <span class="o">=</span> <span class="n">isoMap</span><span class="p">(</span><span class="n">H1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">R</span><span class="o">**</span><span class="n">r4</span><span class="p">)</span> <span class="o">*</span> <span class="n">K2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Converting K1 and K2 to numbers</span>
</span></span><span class="line"><span class="cl">        <span class="n">K1</span> <span class="o">=</span> <span class="n">invIsoMap</span><span class="p">(</span><span class="n">K1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">K2</span> <span class="o">=</span> <span class="n">invIsoMap</span><span class="p">(</span><span class="n">K2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Sending state back to server</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r4</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">usedStates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">shell</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">shell</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">shell</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34; &#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">shell</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></div>
  <p></p>
</details>

</blockquote>
<p>This gives us the flag</p>
<p><code>HTB{k33p_r0t4t1ng_4nd_r0t4t1ng_4nd_x0r1ng_4nd_r0t4t1ng!}</code></p>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://lachlans7.com/js/toc.js'></script>
<link rel="stylesheet" href='https://lachlans7.com/css/toc.css' />

<div id="gitalk-container" class="gitalk-container"></div>
<link rel="stylesheet" href='https://lachlans7.com/css/gitalk.css'>
<script src='https://lachlans7.com/js/gitalk.min.js'></script>
<script>
  const gitalk = new Gitalk({
    clientID: 'Your client ID',
    clientSecret: 'Your client secret',
    repo: 'repo',
    owner: 'LachlanS7',
    admin: ['LachlanS7'],
    id: eval("location.pathname"), 
    distractionFreeMode: false 
  });
  (function() {
    gitalk.render('gitalk-container');
  })();
</script>


  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://lachlans7.com/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://lachlans7.com/js/github-style.js"></script>

<link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"
  integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
<script defer src="https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"
  integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
<script defer src="https://fastly.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"
  integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
  onload="renderMathInElement(document.body);"></script>




</html>